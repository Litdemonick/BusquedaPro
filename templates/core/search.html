{% extends 'base.html' %}
{% load static %}
{% load extras %}
{% block title %}Buscar - Twittor{% endblock %}

{% block extra_css %}
<style>
.autocomplete-results {
    display: none;
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: white;
    border: 1px solid #ddd;
    border-top: none;
    max-height: 200px;
    overflow-y: auto;
    z-index: 1000;
    border-radius: 0 0 8px 8px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
}

.autocomplete-result {
    padding: 10px 12px;
    cursor: pointer;
    border-bottom: 1px solid #f0f0f0;
    transition: background-color 0.2s;
}

.autocomplete-result:hover,
.autocomplete-result.selected {
    background-color: #f8f9fa;
}

.autocomplete-result:last-child {
    border-bottom: none;
}

.search-container {
    position: relative;
    margin-bottom: 20px;
}

#search-input {
    width: 100%;
    padding: 12px;
    border: 1px solid #ddd;
    border-radius: 8px;
    font-size: 16px;
    box-sizing: border-box;
}

#search-input:focus {
    outline: none;
    border-color: #3b82f6;
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}

.line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
}

/* Estilos para hashtags */
.hashtag {
    color: #3b82f6;
    font-weight: 500;
    text-decoration: none;
}

.hashtag:hover {
    text-decoration: underline;
    color: #1d4ed8;
}

.dark .hashtag {
    color: #60a5fa;
}

.dark .hashtag:hover {
    color: #93c5fd;
}
</style>
{% endblock %}

{% block content %}
<div class="search-container">
    <input 
        type="text" 
        id="search-input" 
        placeholder="Buscar temas, usuarios, #hashtags..." 
        autocomplete="off"
        value="{{ q }}"
    >
    <div id="autocomplete-results" class="autocomplete-results"></div>
</div>

<div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
  <!-- Columna principal de resultados -->
  <section class="lg:col-span-3 space-y-4">
    <h1 class="text-xl font-bold">
        {% if q %}
            Resultados para "{{ q }}"
        {% else %}
            Buscar en Twittor
        {% endif %}
    </h1>
    
    {% for t in tweets %}
      <article class="card p-4">
        <div class="flex items-start gap-3">
          <a href="{% url 'profile' t.user.username %}">
            {% if t.user.userprofile.avatar %}
              <img src="{{ t.user.userprofile.avatar.url }}" class="w-10 h-10 rounded-full object-cover" alt="@{{ t.user.username }}">
            {% else %} 
              <div class="w-10 h-10 rounded-full bg-gray-200 dark:bg-gray-800 flex items-center justify-center font-semibold">
                {{ t.user.username|first|upper }}
              </div>
            {% endif %}
          </a>
          <div class="flex-1">
            <div class="flex items-center gap-2">
              <a href="{% url 'profile' t.user.username %}" class="font-semibold hover:underline">@{{ t.user.username }}</a>
              <span class="text-xs text-gray-500 dark:text-gray-400">{{ t.created_at|date:"d/m/Y H:i" }}</span>
            </div>
            
            <!-- Contenido del tweet con hashtags convertidos -->
            <div class="mt-1 whitespace-pre-wrap tweet-content">
              {{ t.content|linkify|safe }}
            </div>
            
            <!-- Mostrar temas si existen -->
            {% if t.temas.all %}
            <div class="mt-2 flex flex-wrap gap-1">
              {% for tema in t.temas.all %}
                <a href="{% url 'tema_feed' tema.slug %}" class="hashtag text-sm">
                  #{{ tema.nombre }}
                </a>
              {% endfor %}
            </div>
            {% endif %}
            
            <!-- Acciones del tweet -->
            <div class="mt-3 flex items-center gap-4 text-sm text-gray-500">
                <button class="flex items-center gap-1 hover:text-red-500">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"/>
                    </svg>
                    <span>{{ t.likes.count }}</span>
                </button>
                <a href="{% url 'tweet_detail' t.id %}" class="flex items-center gap-1 hover:text-blue-500">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>
                    </svg>
                    <span>{{ t.comments.count }}</span>
                </a>
            </div>
          </div>
        </div>
      </article>
    {% empty %}
      <div class="card p-6 text-center">
        <svg class="w-12 h-12 mx-auto mb-3 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
        </svg>
        <p class="text-gray-500">No se encontraron publicaciones para "{{ q }}"</p>
        <p class="text-sm text-gray-400 mt-1">Intenta con otros t√©rminos de b√∫squeda</p>
      </div>
    {% endfor %}
  </section>
  
  <!-- Sidebar con perfiles relacionados y usuarios -->
  <aside class="lg:col-span-1 space-y-6">
    <!-- Bloque de Perfiles Relacionados -->
    {% include "related_profiles.html" %}
    
    <!-- Bloque de Usuarios encontrados -->
    {% if users %}
    <div class="card p-4">
      <h2 class="font-semibold text-lg mb-3">Usuarios encontrados</h2>
      <div class="space-y-3">
        {% for u in users %}
          <a href="{% url 'profile' u.username %}" class="flex items-center gap-3 p-2 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-800 transition-colors">
            {% if u.userprofile.avatar %}
              <img src="{{ u.userprofile.avatar.url }}" class="w-8 h-8 rounded-full object-cover">
            {% else %}  
              <div class="w-8 h-8 rounded-full bg-gray-200 dark:bg-gray-800 flex items-center justify-center text-xs font-semibold">
                {{ u.username|first|upper }}
              </div>
            {% endif %}
            <div class="flex-1 min-w-0">
              <div class="font-medium text-sm truncate">@{{ u.username }}</div>
              {% if u.get_full_name %}
                <div class="text-xs text-gray-500 dark:text-gray-400 truncate">{{ u.get_full_name }}</div>
              {% endif %}
            </div>
          </a>
        {% endfor %}
      </div>
    </div>
    {% endif %}
  </aside>
</div>
{% endblock %}

{% block extra_js %}
<script>
console.log('üéØ Autocomplete iniciado');

class Autocomplete {
    constructor(inputId, resultsId) {
        this.input = document.getElementById(inputId);
        this.resultsContainer = document.getElementById(resultsId);
        this.selectedIndex = -1;
        this.results = [];
        this.init();
    }
    
    init() {
        this.input.addEventListener('input', (e) => {
            this.handleInput(e.target.value);
        });
        
        this.input.addEventListener('keydown', (e) => {
            this.handleKeyDown(e);
        });
        
        document.addEventListener('click', (e) => {
            if (!this.resultsContainer.contains(e.target) && e.target !== this.input) {
                this.hideResults();
            }
        });
    }
    
    async handleInput(query) {
        console.log('üîç Buscando:', query);
        
        if (query.length < 2) {
            this.hideResults();
            return;
        }
        
        try {
            const response = await fetch(`/autocomplete/?q=${encodeURIComponent(query)}`);
            
            if (!response.ok) {
                throw new Error(`Error HTTP: ${response.status}`);
            }
            
            const data = await response.json();
            console.log('üì¶ Respuesta del servidor:', data);
            
            this.results = data.results || [];
            this.showResults();
        } catch (error) {
            console.error('‚ùå Error:', error);
            this.hideResults();
        }
    }
    
    showResults() {
        if (this.results.length === 0) {
            this.hideResults();
            return;
        }
        
        this.resultsContainer.innerHTML = '';
        this.results.forEach((result, index) => {
            const div = document.createElement('div');
            div.className = 'autocomplete-result';
            div.textContent = result;
            div.dataset.value = result;
            
            div.addEventListener('click', () => {
                this.selectResult(result);
            });
            
            this.resultsContainer.appendChild(div);
        });
        
        this.resultsContainer.style.display = 'block';
        this.selectedIndex = -1;
        
        console.log('‚úÖ Mostrando', this.results.length, 'resultados');
    }
    
    hideResults() {
        this.resultsContainer.style.display = 'none';
        this.selectedIndex = -1;
    }
    
    handleKeyDown(e) {
        switch(e.key) {
            case 'ArrowDown':
                e.preventDefault();
                this.navigateResults(1);
                break;
            case 'ArrowUp':
                e.preventDefault();
                this.navigateResults(-1);
                break;
            case 'Enter':
                if (this.selectedIndex >= 0) {
                    e.preventDefault();
                    this.selectResult(this.results[this.selectedIndex]);
                }
                break;
            case 'Escape':
                this.hideResults();
                break;
        }
    }
    
    navigateResults(direction) {
        if (this.results.length === 0) return;
        
        if (this.selectedIndex >= 0) {
            this.resultsContainer.children[this.selectedIndex].classList.remove('selected');
        }
        
        this.selectedIndex += direction;
        
        if (this.selectedIndex < 0) {
            this.selectedIndex = this.results.length - 1;
        } else if (this.selectedIndex >= this.results.length) {
            this.selectedIndex = 0;
        }
        
        this.resultsContainer.children[this.selectedIndex].classList.add('selected');
        
        this.resultsContainer.children[this.selectedIndex].scrollIntoView({
            block: 'nearest'
        });
    }
    
    selectResult(value) {
        this.input.value = value;
        this.hideResults();
        console.log('üéØ Seleccionado:', value);
    }
}

// Funci√≥n para convertir hashtags en el contenido
function convertHashtags() {
    const tweetContents = document.querySelectorAll('.tweet-content');
    
    tweetContents.forEach(content => {
        let html = content.innerHTML;
        
        // Convertir hashtags en el texto
        html = html.replace(/#(\w+)/g, '<a href="/search/?q=$1" class="hashtag">#$1</a>');
        
        content.innerHTML = html;
    });
}

// Inicializar autocomplete y conversi√≥n de hashtags
document.addEventListener('DOMContentLoaded', function() {
    new Autocomplete('search-input', 'autocomplete-results');
    convertHashtags();
    
    // Funcionalidad para botones de seguir en perfiles relacionados
    const followButtons = document.querySelectorAll('.follow-btn');
    
    followButtons.forEach(button => {
        button.addEventListener('click', async function() {
            const userId = this.dataset.userId;
            const username = this.dataset.username;
            
            try {
                const response = await fetch(`/follow/${userId}/`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': getCSRFToken(),
                        'Content-Type': 'application/json',
                    },
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.following) {
                        this.textContent = 'Siguiendo';
                        this.classList.remove('btn-primary');
                        this.classList.add('btn-outline');
                    } else {
                        this.textContent = 'Seguir';
                        this.classList.remove('btn-outline');
                        this.classList.add('btn-primary');
                    }
                }
            } catch (error) {
                console.error('Error al seguir usuario:', error);
            }
        });
    });
    
    function getCSRFToken() {
        const name = 'csrftoken';
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
});
</script>
{% endblock %}