{% extends 'base.html' %}
{% load static %}
{% load extras %}
{% block title %}Inicio - Twittor{% endblock %}

{% block extra_css %}
<style>
/* Estilos mejorados para la barra de scroll personalizada */
#suggested-users-container {
  scrollbar-width: thin;
  scrollbar-color: #c1c1c1 #f1f1f1;
}

#suggested-users-container::-webkit-scrollbar {
  width: 6px;
}

#suggested-users-container::-webkit-scrollbar-track {
  background: #f1f1f1;
  border-radius: 10px;
  margin: 5px 0;
}

#suggested-users-container::-webkit-scrollbar-thumb {
  background: #c1c1c1;
  border-radius: 10px;
  border: 1px solid #f1f1f1;
}

#suggested-users-container::-webkit-scrollbar-thumb:hover {
  background: #a8a8a8;
}

/* Para modo oscuro */
.dark #suggested-users-container {
  scrollbar-color: #6b7280 #374151;
}

.dark #suggested-users-container::-webkit-scrollbar-track {
  background: #374151;
}

.dark #suggested-users-container::-webkit-scrollbar-thumb {
  background: #6b7280;
  border: 1px solid #374151;
}

.dark #suggested-users-container::-webkit-scrollbar-thumb:hover {
  background: #9ca3af;
}

/* Animaciones para los botones de seguir */
.follow-btn {
  transition: all 0.3s ease;
  position: relative;
  overflow: hidden;
  /* Asegurar estilos base */
  padding: 0.25rem 0.75rem;
  font-size: 0.75rem;
  font-weight: 600;
  border-radius: 9999px;
  color: white;
}

.follow-btn.loading {
  opacity: 0.7;
  pointer-events: none;
}

.follow-btn.loading::after {
  content: '';
  position: absolute;
  top: 50%;
  left: 50%;
  width: 16px;
  height: 16px;
  margin: -8px 0 0 -8px;
  border: 2px solid transparent;
  border-top: 2px solid #ffffff;
  border-radius: 50%;
  animation: spin 1s linear infinite;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

/* Animación de éxito */
.follow-btn.success {
  animation: pulse 0.5s ease;
}

@keyframes pulse {
  0% { transform: scale(1); }
  50% { transform: scale(1.05); }
  100% { transform: scale(1); }
}

.hidden {
  display: none !important;
}

/* Estilos para la barra de búsqueda */
.search-bar-container {
  margin-bottom: 2rem;
}

.search-container {
  position: relative;
  max-width: 500px;
  margin: 0 auto;
}

.search-input {
  width: 100%;
  padding: 0.75rem 1rem 0.75rem 2.5rem;
  border-radius: 9999px;
  border: 1px solid #d1d5db;
  background-color: #f9fafb;
  transition: all 0.2s ease;
  font-size: 0.875rem;
}

.dark .search-input {
  background-color: #374151;
  border-color: #4b5563;
  color: #f9fafb;
}

.search-input:focus {
  outline: none;
  border-color: #3b82f6;
  background-color: white;
  box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}

.dark .search-input:focus {
  background-color: #4b5563;
}

.search-icon {
  position: absolute;
  left: 0.75rem;
  top: 50%;
  transform: translateY(-50%);
  color: #6b7280;
  pointer-events: none;
}

.search-results {
  position: absolute;
  top: 100%;
  left: 0;
  right: 0;
  background-color: white;
  border: 1px solid #e5e7eb;
  border-radius: 0.75rem;
  margin-top: 0.5rem;
  box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
  z-index: 50;
  max-height: 300px;
  overflow-y: auto;
  display: none;
}

.dark .search-results {
  background-color: #374151;
  border-color: #4b5563;
}

.search-result-item {
  padding: 0.75rem 1rem;
  border-bottom: 1px solid #f3f4f6;
  cursor: pointer;
  transition: background-color 0.2s ease;
}

.dark .search-result-item {
  border-bottom-color: #4b5563;
}

.search-result-item:hover {
  background-color: #f9fafb;
}

.dark .search-result-item:hover {
  background-color: #4b5563;
}

.search-result-item:last-child {
  border-bottom: none;
}

.search-result-username {
  font-weight: 600;
  color: #111827;
}

.dark .search-result-username {
  color: #f9fafb;
}

.search-result-bio {
  font-size: 0.75rem;
  color: #6b7280;
  margin-top: 0.25rem;
}

.no-results {
  padding: 1rem;
  text-align: center;
  color: #6b7280;
  font-size: 0.875rem;
}
</style>
{% endblock %}

{% block content %}

<!-- Barra de búsqueda agregada aquí -->
<div class="search-bar-container">
    <div class="search-container">
        <div class="search-icon">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" />
            </svg>
        </div>
        <input 
            type="text" 
            id="search-input" 
            class="search-input" 
            placeholder="Buscar usuarios en Twittor..." 
            autocomplete="off"
        >
        <div id="search-results" class="search-results"></div>
    </div>
</div>

<div class="grid grid-cols-1 md:grid-cols-3 gap-4 md:gap-6">
  <section class="md:col-span-2 space-y-4">
    <!-- Tu contenido del timeline (sin cambios) -->
    <div class="card p-4">
      <form action="{% url 'timeline' %}" method="post" enctype="multipart/form-data" class="space-y-3">
        {% csrf_token %}
        {{ form.non_field_errors }}
        {% if form.errors %}<div class="text-red-600 text-sm">{{ form.errors }}</div>{% endif %}
        {{ form.content }}
        <div class="flex items-center justify-between">
          {{ form.image }}
          <button class="px-4 py-2 bg-blue-600 text-white rounded-xl">Publicar</button>
        </div>
      </form>
    </div>

    {% for t in tweets %}
    <article class="card p-4">
      <div class="flex gap-3">
        <a href="{% url 'profile' t.user.username %}">
  {% if t.user.userprofile.avatar %}
    <img src="{{ t.user.userprofile.avatar.url }}" class="w-10 h-10 rounded-full object-cover" alt="@{{ t.user.username }}">
  {% else %} 
    <div class="w-10 h-10 rounded-full bg-gray-200 dark:bg-gray-800 flex items-center justify-center font-semibold">
      {{ t.user.username|first|upper }}
    </div>
  {% endif %}
</a>
        <div class="flex-1">
          <div class="flex items-center gap-2">
            <a href="{% url 'profile' t.user.username %}" class="font-semibold hover:underline">@{{ t.user.username }}</a>
            <span class="text-xs text-gray-500 dark:text-gray-400">{{ t.created_at|date:"d/m/Y H:i" }}</span>
          </div>
          <a href="{{ t.get_absolute_url }}">
            <p class="mt-1 whitespace-pre-wrap">{{ t.content|linkify|safe }}</p>
          {% if t.parent %}
            <a href="{{ t.parent.get_absolute_url }}" class="block border rounded-xl p-3 mt-2 text-sm bg-gray-50 dark:bg-gray-800 dark:border-gray-700 dark:text-gray-100">
              <span class="text-gray-500">Publicación original de @{{ t.parent.user.username }}:</span>
              <div class="whitespace-pre-wrap">{{ t.parent.content|linkify|safe }}</div>
            </a>
          {% endif %}
          </a>
          {% if t.image %}
            <img src="{{ t.image.url }}" class="mt-2 rounded-xl border dark:border-gray-700 w-full h-auto max-h-[70vh] object-cover" alt="imagen">
          {% endif %}
          <div class="mt-3 flex items-center gap-4">
            {% include "components/like_button.html" with t=t %}
            <a href="{{ t.get_absolute_url }}" class="text-sm px-3 py-1 rounded-xl border hover:bg-gray-50 dark:hover:bg-gray-800 transition">Responder</a>
            <form action="{% url 'retweet' t.pk %}" method="post" class="inline">{% csrf_token %}<button class="text-sm px-3 py-1 rounded-lg border">Retwittear</button></form>
            <a href="{% url 'quote' t.pk %}" class="text-sm px-3 py-1 rounded-lg border">Citar</a>
          </div>
        </div>
      </div>
    </article>
    {% empty %}
      <p class="text-gray-500">No hay publicaciones aún. ¡Sé el primero!</p>
    {% endfor %}
  </section>

  <aside class="space-y-4">
  <!-- Bloque de Perfiles Relacionados -->
  {% if suggested_users %}
  <div class="card p-4 bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700">
    <div class="suggested-header border-b border-gray-200 dark:border-gray-700 pb-3 mb-3">
      <h2 class="font-bold text-lg text-gray-900 dark:text-white">Perfiles relacionados</h2>
    </div>
    
    <div id="suggested-users-container" class="suggested-users-list space-y-4 max-h-96 overflow-y-auto" 
         data-next-page="2" data-has-more="true">
      <!-- Los usuarios iniciales se cargan aquí -->
      {% for user in suggested_users %}
      <div class="suggested-user-item flex items-center justify-between hover:bg-gray-50 dark:hover:bg-gray-700 p-2 rounded-lg transition-colors" 
           data-user-id="{{ user.id }}">
        <div class="flex items-center space-x-3 flex-1 min-w-0">
          <a href="{% url 'profile' user.username %}" class="flex-shrink-0">
            {% if user.userprofile.avatar %}
              <img src="{{ user.userprofile.avatar.url }}" class="w-10 h-10 rounded-full object-cover" alt="@{{ user.username }}">
            {% else %}
              <div class="w-10 h-10 rounded-full bg-blue-500 flex items-center justify-center font-semibold text-white">
                {{ user.username|first|upper }}
              </div>
            {% endif %}
          </a>
          
          <div class="user-info flex-1 min-w-0">
            <a href="{% url 'profile' user.username %}" class="block">
              <h4 class="font-semibold text-sm text-gray-900 dark:text-white truncate hover:underline">
                @{{ user.username }}
              </h4>
            </a>
            {% if user.userprofile.bio %}
              <p class="text-xs text-gray-500 dark:text-gray-400 truncate mt-1">
                {{ user.userprofile.bio|truncatewords:8 }}
              </p>
            {% else %}
              <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">
                Usuario de Twittor
              </p>
            {% endif %}
            <span class="text-xs text-gray-400 dark:text-gray-500 followers-count" 
                  data-user-id="{{ user.id }}">
              {{ user.followers_count }} seguidores
            </span>
          </div>
        </div>
        
        <div class="follow-action flex-shrink-0 ml-2">
          <button type="button" 
                  class="follow-btn px-3 py-1 text-white text-xs font-semibold rounded-full transition-colors {% if user.id in following_ids %}bg-gray-600 hover:bg-gray-700{% else %}bg-blue-600 hover:bg-blue-700{% endif %}"
                  data-user-id="{{ user.id }}"
                  data-following="{% if user.id in following_ids %}true{% else %}false{% endif %}">
            {% if user.id in following_ids %}Dejar de seguir{% else %}Seguir{% endif %}
          </button>
        </div>
      </div>
      {% endfor %}
    </div>
    
    <!-- Footer oculto -->
    <div class="suggested-footer border-t border-gray-200 dark:border-gray-700 pt-3 mt-3 text-center hidden">
      <div id="loading-indicator" class="py-2">
        <div class="inline-block animate-spin rounded-full h-4 w-4 border-b-2 border-blue-600"></div>
      </div>
    </div>
  </div>
  {% endif %}

  <div class="card p-4">
    <h2 class="font-bold mb-2">Consejo</h2>
    <p class="text-sm text-gray-600">Sigue a personas para ver sus publicaciones en tu inicio.</p>
  </div>
</aside>

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', () => {
  // Tu código existente para autocomplete
  const ta = document.querySelector('textarea[name="content"]');
  if (ta && typeof setupAutocomplete === 'function') {
    setupAutocomplete(ta, {
      endpointMention: "{% url 'autocomplete_mention' %}",
      endpointHashtag: "{% url 'autocomplete_hashtag' %}",
      minChars: 1
    });
  }

  // Código para scroll infinito en sugerencias de usuarios
  const suggestedUsersContainer = document.getElementById('suggested-users-container');
  
  if (suggestedUsersContainer) {
    let isLoading = false;
    
    suggestedUsersContainer.addEventListener('scroll', function() {
      const scrollThreshold = 0.9;
      const scrollPosition = this.scrollTop + this.clientHeight;
      const scrollHeight = this.scrollHeight;
      
      if (!isLoading && 
          scrollPosition >= scrollHeight * scrollThreshold && 
          this.dataset.hasMore === 'true') {
        
        loadMoreUsers();
      }
    });
    
    function loadMoreUsers() {
      isLoading = true;
      
      const nextPage = suggestedUsersContainer.dataset.nextPage;
      
      fetch(`{% url 'load_more_suggested_users' %}?page=${nextPage}`)
        .then(response => {
          if (!response.ok) {
            throw new Error('Network response was not ok');
          }
          return response.json();
        })
        .then(data => {
          if (data.html) {
            suggestedUsersContainer.insertAdjacentHTML('beforeend', data.html);
          }
          
          suggestedUsersContainer.dataset.nextPage = data.next_page;
          suggestedUsersContainer.dataset.hasMore = data.has_more.toString();
          
          isLoading = false;
        })
        .catch(error => {
          console.error('Error loading more users:', error);
          isLoading = false;
        });
    }
  }

  // Sistema de seguir/dejar de seguir con AJAX - CORREGIDO
  document.addEventListener('click', function(e) {
    if (e.target.classList.contains('follow-btn')) {
      const button = e.target;
      const userId = button.dataset.userId;
      
      // Mostrar estado de carga
      button.classList.add('loading');
      
      // Enviar solicitud AJAX
      fetch(`/toggle_follow/${userId}/`, {
        method: 'POST',
        headers: {
          'X-CSRFToken': '{{ csrf_token }}',
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({})
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          // Actualizar texto del botón
          button.textContent = data.button_text;
          
          // CORRECCIÓN: Mantener clases base y solo cambiar las de color
          // Remover clases de color existentes
          button.classList.remove('bg-blue-600', 'hover:bg-blue-700', 'bg-gray-600', 'hover:bg-gray-700');
          
          // Agregar nuevas clases de color
          const colorClasses = data.button_class.split(' ');
          colorClasses.forEach(className => {
            button.classList.add(className);
          });
          
          // Actualizar estado de seguimiento
          button.dataset.following = (data.action === 'follow').toString();
          
          // Actualizar contador de seguidores
          const followersCountElement = document.querySelector(`.followers-count[data-user-id="${userId}"]`);
          if (followersCountElement) {
            followersCountElement.textContent = `${data.followers_count} seguidores`;
          }
          
          // Animación de éxito
          button.classList.remove('loading');
          button.classList.add('success');
          setTimeout(() => {
            button.classList.remove('success');
          }, 500);
        }
      })
      .catch(error => {
        console.error('Error:', error);
        button.classList.remove('loading');
      });
    }
  });

  // Código para la barra de búsqueda
  const searchInput = document.getElementById('search-input');
  const searchResults = document.getElementById('search-results');
  let searchTimeout;

  if (searchInput && searchResults) {
    // Mostrar/ocultar resultados al enfocar/desenfocar
    searchInput.addEventListener('focus', () => {
      if (searchResults.innerHTML.trim() !== '') {
        searchResults.style.display = 'block';
      }
    });

    document.addEventListener('click', (e) => {
      if (!searchInput.contains(e.target) && !searchResults.contains(e.target)) {
        searchResults.style.display = 'none';
      }
    });

    // Buscar mientras se escribe
    searchInput.addEventListener('input', (e) => {
      clearTimeout(searchTimeout);
      const query = e.target.value.trim();
      
      if (query.length < 2) {
        searchResults.style.display = 'none';
        searchResults.innerHTML = '';
        return;
      }
      
      searchTimeout = setTimeout(() => {
        performSearch(query);
      }, 300);
    });

    function performSearch(query) {
      fetch(`/search_users/?q=${encodeURIComponent(query)}`)
        .then(response => {
          if (!response.ok) {
            throw new Error('Network response was not ok');
          }
          return response.json();
        })
        .then(data => {
          displaySearchResults(data.users || []);
        })
        .catch(error => {
          console.error('Error searching users:', error);
          searchResults.innerHTML = '<div class="no-results">Error al buscar usuarios</div>';
          searchResults.style.display = 'block';
        });
    }

    function displaySearchResults(users) {
      if (users.length === 0) {
        searchResults.innerHTML = '<div class="no-results">No se encontraron usuarios</div>';
        searchResults.style.display = 'block';
        return;
      }

      let html = '';
      users.forEach(user => {
        html += `
          <div class="search-result-item" data-username="${user.username}">
            <div class="search-result-username">@${user.username}</div>
            ${user.bio ? `<div class="search-result-bio">${user.bio}</div>` : ''}
          </div>
        `;
      });

      searchResults.innerHTML = html;
      searchResults.style.display = 'block';

      // Agregar evento click a los resultados
      searchResults.querySelectorAll('.search-result-item').forEach(item => {
        item.addEventListener('click', () => {
          const username = item.dataset.username;
          window.location.href = `/profile/${username}/`;
        });
      });
    }
  }
});
</script>
{% endblock %}

{% endblock %}